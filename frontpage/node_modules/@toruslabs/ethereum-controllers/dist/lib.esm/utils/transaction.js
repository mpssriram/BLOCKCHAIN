import { createCustomCommon, Mainnet } from '@ethereumjs/common';
import { createTxFromRLP } from '@ethereumjs/tx';
import { hexToBytes, addHexPrefix, bytesToHex } from '@ethereumjs/util';
import log from 'loglevel';
import { METHOD_TYPES } from './constants.js';

/**
 * Transaction decoder for analytics.
 * Decodes eth_sendRawTransaction and eth_sendUserOperation requests.
 */
const transactionDecoder = (req, chainId) => {
  let sender = "";
  let txHash = "";
  try {
    if (req.method === METHOD_TYPES.ETH_SEND_RAW_TRANSACTION) {
      const rawTx = req.params[0];
      const txBytes = hexToBytes(addHexPrefix(rawTx));
      const tx = createTxFromRLP(txBytes, {
        common: createCustomCommon({
          chainId
        }, Mainnet)
      });
      sender = tx.getSenderAddress().toString();
      txHash = bytesToHex(tx.hash());
    } else if (req.method === METHOD_TYPES.ETH_SEND_USER_OPERATION) {
      const userOpReq = req;
      sender = userOpReq.params.map(p => p.sender).join(",");
    }
  } catch (error) {
    log.error("Error decoding transaction", error, {
      req,
      chainId
    });
  }
  return [sender, txHash];
};

export { transactionDecoder };
