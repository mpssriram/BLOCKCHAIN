var ce=Object.defineProperty;var ue=(e,t,n)=>t in e?ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var M=(e,t,n)=>ue(e,typeof t!="symbol"?t+"":t,n);import{ah as de,ai as le,aj as E,ak as P,al as fe,am as me,an as z,ao as he,_ as c,ap as x}from"./index-BtKwAIK5.js";class L{constructor(t){M(this,"ttl");M(this,"map",new Map);M(this,"_to",!1);this.ttl=t}has(t){return this.map.has(t)}add(t){this.map.set(t,F()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,ge(this)},0))}clear(){this.map.clear()}}function ge(e){const t=F()-e.ttl,n=e.map[Symbol.iterator]();for(;;){const s=n.next().value;if(!s)return;const o=s[0];if(s[1]<t)e.map.delete(o);else return}}function F(){return Date.now()}function pe(e){return!!(e&&typeof e.then=="function")}Promise.resolve(!1);Promise.resolve(!0);const p=Promise.resolve();function I(e,t){return e||(e=0),new Promise(n=>{setTimeout(()=>n(t),e)})}function _e(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function w(){return Math.random().toString(36).substring(2)}let S=0;function h(){let e=Date.now()*1e3;return e<=S&&(e=S+1),S=e,e}const l=de.getLogger("broadcast-channel");l.setLevel("error");const ve="https://api.web3auth.io/session-service",ye="https://session.web3auth.io";function k(e={}){const t=JSON.parse(JSON.stringify(e));return typeof t.webWorkerSupport>"u"&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=1e3*45),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&typeof e.idb.onclose=="function"&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=1e3*60),t.server||(t.server={}),t.server.api_url||(t.server.api_url=`${ve}/v2`),t.server.socket_url||(t.server.socket_url=`${ye}`),t.server.removeTimeout||(t.server.removeTimeout=1e3*60*5),e.methods&&(t.methods=e.methods),t}const we=h,be="pubkey.broadcast-channel-0-",f="messages",_={durability:"relaxed"},Me="idb";function T(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){const e=window;if(typeof e.mozIndexedDB<"u")return e.mozIndexedDB;if(typeof e.webkitIndexedDB<"u")return e.webkitIndexedDB;if(typeof e.msIndexedDB<"u")return e.msIndexedDB}return!1}function b(e){e.commit&&e.commit()}function J(e){const t=T();if(!t)return Promise.reject(new Error("IndexedDB not available"));const n=be+e,s=t.open(n);return s.onupgradeneeded=r=>{r.target.result.createObjectStore(f,{keyPath:"id",autoIncrement:!0})},new Promise((r,i)=>{s.onerror=a=>i(a),s.onsuccess=()=>{r(s.result)}})}function V(e,t,n){const s=Date.now(),o={uuid:t,time:s,data:n},r=e.transaction([f],"readwrite",_);return new Promise((i,a)=>{r.oncomplete=()=>i(),r.onerror=d=>a(d),r.objectStore(f).add(o),b(r)})}function ke(e){const t=e.transaction(f,"readonly",_),n=t.objectStore(f),s=[];return new Promise(o=>{n.openCursor().onsuccess=r=>{const i=r.target.result;i?(s.push(i.value),i.continue()):(b(t),o(s))}})}function W(e,t){const n=e.transaction(f,"readonly",_),s=n.objectStore(f),o=[];let r=IDBKeyRange.bound(t+1,1/0);if(s.getAll){const a=s.getAll(r);return new Promise((u,d)=>{a.onerror=g=>d(g),a.onsuccess=function(g){u(g.target.result)}})}function i(){try{return r=IDBKeyRange.bound(t+1,1/0),s.openCursor(r)}catch{return s.openCursor()}}return new Promise((a,u)=>{const d=i();d.onerror=g=>u(g),d.onsuccess=g=>{const m=g.target.result;m?m.value.id<t+1?m.continue(t+1):(o.push(m.value),m.continue()):(b(n),a(o))}})}function q(e,t){const s=e.transaction([f],"readwrite",_).objectStore(f);return Promise.all(t.map(o=>{const r=s.delete(o);return new Promise(i=>{r.onsuccess=()=>i()})}))}function H(e,t){const n=Date.now()-t,s=e.transaction(f,"readonly",_),o=s.objectStore(f),r=[];return new Promise(i=>{o.openCursor().onsuccess=a=>{const u=a.target.result;if(u){const d=u.value;d.time<n?(r.push(d),u.continue()):(b(s),i(r))}else i(r)}})}function X(e,t){return H(e,t).then(n=>q(e,n.map(s=>s.id)))}function Se(e,t){return t=k(t),J(e).then(n=>{const s={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:w(),eMIs:new L(t.idb.ttl*2),writeBlockPromise:p,messagesCallback:null,readQueuePromises:[],db:n,time:h()};return n.onclose=function(){s.closed=!0,t.idb.onclose&&t.idb.onclose()},Y(s),s})}function Y(e){e.closed||G(e).then(()=>I(e.options.idb.fallbackInterval)).then(()=>Y(e)).catch(t=>{throw t})}function Ee(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}function G(e){return e.closed||!e.messagesCallback?p:W(e.db,e.lastCursorId).then(t=>(t.filter(s=>!!s).map(s=>(s.id>e.lastCursorId&&(e.lastCursorId=s.id),s)).filter(s=>Ee(s,e)).sort((s,o)=>s.time-o.time).forEach(s=>{e.messagesCallback&&(e.eMIs.add(s.id),e.messagesCallback(s.data))}),p))}function Pe(e){e.closed=!0,e.db.close()}function Ce(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(()=>V(e.db,e.uuid,t)).then(()=>(_e(0,10)===0&&X(e.db,e.options.idb.ttl),p)),e.writeBlockPromise}function Le(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t,G(e)}function Ie(){return!!T()}function Te(e){return e.idb.fallbackInterval*2}const $e=Object.freeze(Object.defineProperty({__proto__:null,TRANSACTION_SETTINGS:_,averageResponseTime:Te,canBeUsed:Ie,cleanOldMessages:X,close:Pe,commitIndexedDBTransaction:b,create:Se,createDatabase:J,getAllMessages:ke,getIdb:T,getMessagesHigherThan:W,getOldMessages:H,microSeconds:we,onMessage:Le,postMessage:Ce,removeMessagesById:q,type:Me,writeMessage:V},Symbol.toStringTag,{value:"Module"})),Be=h,Ne="pubkey.broadcastChannel-",Q="localstorage";function $(){let e=null;if(typeof window>"u")return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch{}return e}function B(e){return Ne+e}function De(e,t){return new Promise((n,s)=>{I().then(()=>{var o;const r=B(e.channelName),i={token:w(),time:Date.now(),data:t,uuid:e.uuid},a=JSON.stringify(i);(o=$())===null||o===void 0||o.setItem(r,a);const u=document.createEvent("StorageEvent");u.initStorageEvent("storage",!0,!0,r,null,a,"",null),window.dispatchEvent(u),n()}).catch(s)})}function Z(e,t){const n=B(e),s=o=>{o.key===n&&o.newValue&&t(JSON.parse(o.newValue))};return window.addEventListener("storage",s),s}function ee(e){window.removeEventListener("storage",e)}function te(){const e=$();if(!e)return!1;try{const t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch{return!1}return!0}function Re(e,t){const n=k(t);if(!te())throw new Error("BroadcastChannel: localstorage cannot be used");const s=w(),o=new L(n.localstorage.removeTimeout),r={channelName:e,uuid:s,time:h(),eMIs:o};return r.listener=Z(e,i=>{r.messagesCallback&&i.uuid!==s&&(!i.token||o.has(i.token)||i.data.time&&i.data.time<(r.messagesCallbackTime||0)||(o.add(i.token),r.messagesCallback(i.data)))}),r}function xe(e){e.listener&&ee(e.listener)}function Oe(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t}function Ae(){const t=navigator.userAgent.toLowerCase();return t.includes("safari")&&!t.includes("chrome")?240:120}const Ue=Object.freeze(Object.defineProperty({__proto__:null,addStorageEventListener:Z,averageResponseTime:Ae,canBeUsed:te,close:xe,create:Re,getLocalStorage:$,microSeconds:Be,onMessage:Oe,postMessage:De,removeStorageEventListener:ee,storageKey:B,type:Q},Symbol.toStringTag,{value:"Module"})),Ke=h,se="native";function je(e){const t={time:h(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=n=>{t.messagesCallback&&t.messagesCallback(n.data)},t}function ze(e){e.bc.close(),e.subFns=[]}function Fe(e,t){try{return e.bc.postMessage(t),p}catch(n){return Promise.reject(n)}}function Je(e,t){e.messagesCallback=t}function Ve(){if(typeof window>"u")return!1;if(typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}return!1}function We(){return 150}const qe=Object.freeze(Object.defineProperty({__proto__:null,averageResponseTime:We,canBeUsed:Ve,close:ze,create:je,microSeconds:Ke,onMessage:Je,postMessage:Fe,type:se},Symbol.toStringTag,{value:"Module"})),He=h,Xe="pubkey.broadcastChannel-",ne="server";let v=null;const y=new Set;function N(e){return Xe+e}function Ye(e,t){return new Promise((n,s)=>{I().then(async()=>{const o=N(e.channelName),r=E(P.from(o,"utf8")),i=await fe(r.toString("hex"),{token:w(),time:Date.now(),data:t,uuid:e.uuid}),a={allowedOrigin:e.server.allowed_origin,sameIpCheck:!0,key:z(r).toString("hex"),data:i,signature:(await me(r,E(P.from(i,"utf8")))).toString("hex")};return e.timeout&&(a.timeout=e.timeout),fetch(`${e.server.api_url}/channel/set`,{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json; charset=utf-8"}}).then(n).catch(s)}).catch(s)})}function oe(e){if(v)return v;const t=le(e,{transports:["websocket","polling"],withCredentials:!0,reconnectionDelayMax:1e4,reconnectionAttempts:10});return t.on("connect_error",n=>{t.io.opts.transports=["polling","websocket"],l.error("connect error",n)}),t.on("connect",async()=>{const{engine:n}=t.io;l.debug("initially connected to",n.transport.name),n.once("upgrade",()=>{l.debug("upgraded",n.transport.name)}),n.once("close",s=>{l.debug("connection closed",s)})}),t.on("error",n=>{l.error("socket errored",n),t.disconnect()}),v=t,t}function re(e,t,n){const s=oe(e),o=N(t.channelName),r=E(P.from(o,"utf8")),i=z(r).toString("hex");s.connected?s.emit("v2:check_auth_status",i,{sameIpCheck:!0,allowedOrigin:t.server.allowed_origin}):s.once("connect",()=>{l.debug("connected with socket"),s.emit("v2:check_auth_status",i,{sameIpCheck:!0,allowedOrigin:t.server.allowed_origin})});const a=()=>{s.once("connect",async()=>{y.has(t.channelName)&&s.emit("v2:check_auth_status",i,{sameIpCheck:!0,allowedOrigin:t.server.allowed_origin})})},u=()=>{if(!s||!y.has(t.channelName)){document.removeEventListener("visibilitychange",u);return}!s.connected&&document.visibilityState==="visible"&&a()},d=async g=>{try{const m=await he(r.toString("hex"),g);l.info(m),n(m)}catch(m){l.error(m)}};return s.on("disconnect",()=>{l.debug("socket disconnected"),y.has(t.channelName)&&(l.error("socket disconnected unexpectedly, reconnecting socket"),a())}),s.on(`${i}_success`,d),typeof document<"u"&&document.addEventListener("visibilitychange",u),s}function Ge(){v&&v.disconnect()}function Qe(){return!0}function Ze(e,t){t=k(t);const n=w(),s=new L(t.server.removeTimeout),o={channelName:e,uuid:n,eMIs:s,server:{api_url:t.server.api_url,socket_url:t.server.socket_url,allowed_origin:t.server.allowed_origin},time:h()};return t.server.timeout&&(o.timeout=t.server.timeout),re(t.server.socket_url,o,r=>{o.messagesCallback&&r.uuid!==o.uuid&&(!r.token||o.eMIs.has(r.token)||(o.eMIs.add(r.token),o.messagesCallback(r.data)))}),y.add(e),o}function et(e){y.delete(e.channelName)}function tt(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t}function st(){return 500}const nt=Object.freeze(Object.defineProperty({__proto__:null,averageResponseTime:st,canBeUsed:Qe,close:et,create:Ze,getSocketInstance:oe,microSeconds:He,onMessage:tt,postMessage:Ye,removeStorageEventListener:Ge,setupSocketConnection:re,storageKey:N,type:ne},Symbol.toStringTag,{value:"Module"})),ot=h,C="simulate",D=new Set,R=5;function rt(e){const t={time:h(),name:e,messagesCallback:null};return D.add(t),t}function it(e){D.delete(e)}function at(e,t){return new Promise(n=>{setTimeout(()=>{Array.from(D).forEach(o=>{o.name===e.name&&o!==e&&o.messagesCallback&&o.time<t.time&&o.messagesCallback(t)}),n()},R)})}function ct(e,t){e.messagesCallback=t}function ut(){return!0}function dt(){return R}const lt=Object.freeze(Object.defineProperty({__proto__:null,SIMULATE_DELAY_TIME:R,averageResponseTime:dt,canBeUsed:ut,close:it,create:rt,microSeconds:ot,onMessage:ct,postMessage:at,type:C},Symbol.toStringTag,{value:"Module"})),O=[qe,$e,Ue,nt];function ft(e){let t=[].concat(e.methods||[],O).filter(Boolean);if(e.type){if(e.type==="simulate")return lt;const s=t.find(o=>o.type===e.type);if(s)return s;throw new Error(`method-type ${e.type} not found`)}e.webWorkerSupport||(t=t.filter(s=>s.type!=="idb"));const n=t.find(s=>s.canBeUsed(e));if(n)return n;throw new Error(`No useable method found in ${JSON.stringify(O.map(s=>s.type))}`)}const A=new Set;let mt=0,ie=class{constructor(t,n){c(this,"id",void 0),c(this,"name",void 0),c(this,"options",void 0),c(this,"method",void 0),c(this,"closed",void 0),c(this,"_addEL",void 0),c(this,"_prepP",void 0),c(this,"_state",void 0),c(this,"_uMP",void 0),c(this,"_iL",void 0),c(this,"_onML",void 0),c(this,"_befC",void 0),this.id=mt++,A.add(this),this.name=t,this.options=k(n||{}),this.method=ft(this.options),this.closed=!1,this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,ht(this)}get type(){return this.method.type}get isClosed(){return this.closed}set onmessage(t){const s={time:this.method.microSeconds(),fn:t};j(this,"message",this._onML),t&&typeof t=="function"?(this._onML=s,K(this,"message",s)):this._onML=null}postMessage(t){if(this.closed)throw new Error(`BroadcastChannel.postMessage(): Cannot post message after channel has closed ${JSON.stringify(t)}`);return U(this,"message",t)}postInternal(t){return U(this,"internal",t)}addEventListener(t,n){const o={time:this.method.microSeconds(),fn:n};K(this,t,o)}removeEventListener(t,n){const s=this._addEL[t].find(o=>o.fn===n);j(this,t,s)}close(){if(this.closed)return Promise.resolve();A.delete(this),this.closed=!0;const t=this._prepP?this._prepP:p;return this._onML=null,this._addEL.message=[],t.then(()=>Promise.all(Array.from(this._uMP))).then(()=>Promise.all(this._befC.map(n=>n()))).then(()=>this.method.close?this.method.close(this._state):p)}};c(ie,"_pubkey",!0);function U(e,t,n){const o={time:e.method.microSeconds(),type:t,data:n};return(e._prepP?e._prepP:p).then(()=>{const i=e.method.postMessage(e._state,o);return e._uMP.add(i),i.catch(()=>{}).then(()=>e._uMP.delete(i)),i})}function ht(e){const t=e.method.create(e.name,e.options);if(pe(t)){const n=t;e._prepP=n,n.then(s=>(e._state=s,s)).catch(s=>{throw s})}else e._state=t}function ae(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function gt(e){if(!e._iL&&ae(e)){const t=s=>{e._addEL[s.type].forEach(o=>{(s.time>=o.time||e.method.type==="server")&&o.fn(s.data)})},n=e.method.microSeconds();e._prepP?e._prepP.then(()=>(e._iL=!0,e.method.onMessage(e._state,t,n),!0)).catch(s=>{throw s}):(e._iL=!0,e.method.onMessage(e._state,t,n))}}function pt(e){if(e._iL&&!ae(e)){e._iL=!1;const t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}function K(e,t,n){e._addEL[t].push(n),gt(e)}function j(e,t,n){n&&(e._addEL[t]=e._addEL[t].filter(s=>s!==n),pt(e))}class wt{constructor(t,n={}){c(this,"name",void 0),c(this,"options",void 0),c(this,"closed",void 0),c(this,"onML",void 0),c(this,"methodPriority",void 0),c(this,"channels",void 0),c(this,"listeners",void 0),c(this,"processedNonces",void 0),c(this,"nonce",void 0),this.name=t,this.options=n,this.closed=!1,this.onML=null,this.methodPriority=[se,Q,ne],this.channels=new Map,this.listeners=new Set,this.processedNonces=new Set,this.nonce=0,this.initChannels()}set onmessage(t){this.removeEventListener("message",this.onML),t&&typeof t=="function"?(this.onML=t,this.addEventListener("message",t)):this.onML=null}initChannels(){if(this.options.type===C&&(this.methodPriority=[C]),this.methodPriority.forEach(t=>{try{const n=new ie(this.name,x(x({},this.options),{},{type:t}));this.channels.set(t,n),l.debug(`Succeeded to initialize ${t} method in channel ${this.name}`),n.onmessage=s=>this.handleMessage(s)}catch(n){l.warn(`Failed to initialize ${t} method in channel ${this.name}: ${n instanceof Error?n.message:String(n)}`)}}),this.channels.size===0)throw new Error("Failed to initialize any communication method")}allChannels(){return Array.from(this.channels.keys())}hasChannel(t){return this.channels.has(t)}handleMessage(t){if(t&&t.nonce){if(this.processedNonces.has(t.nonce))return;if(this.processedNonces.add(t.nonce),this.processedNonces.size>1e3){const s=Array.from(this.processedNonces).sort()[0];this.processedNonces.delete(s)}this.listeners.forEach(n=>{n(t.message)})}}async postMessage(t){if(this.closed)throw new Error(`AdaptiveBroadcastChannel.postMessage(): Cannot post message after channel has closed ${JSON.stringify(t)}`);const s={nonce:this.generateNonce(),message:t},o=Array.from(this.channels.entries()).map(([a,u])=>u.postMessage(s).catch(d=>{throw l.warn(`Failed to send via ${a}: ${d.message}`),d}));if(!(await Promise.allSettled(o)).some(a=>a.status==="fulfilled"))throw new Error("Failed to send message through any method");return t}generateNonce(){return`${Date.now()}-${this.nonce++}`}addEventListener(t,n){this.listeners.add(n)}removeEventListener(t,n){this.listeners.delete(n)}async close(){if(this.closed)return;this.onML=null;const t=[];for(const n of this.channels.values())t.push(n.close());await Promise.all(t),this.channels.clear(),this.listeners.clear(),this.closed=!0}}export{ie as BroadcastChannel,$e as IndexedDbMethod,Ue as LocalstorageMethod,qe as NativeMethod,A as OPEN_BROADCAST_CHANNELS,wt as RedundantAdaptiveBroadcastChannel,nt as ServerMethod,ft as chooseMethod};
