import { rpcErrors } from '@web3auth/auth';
import { getDelegationAddress } from './eip7702Utils.js';

/**
 * Get the EIP7702 upgrade status of an EOA.
 *
 * @param request - The request object.
 * @param getEthCode - The function to get the code of an account.
 * @returns The upgrade status.
 */
async function walletGetUpgradeStatus(request, getEthCode) {
  const {
    method,
    params
  } = request;
  if (method !== "wallet_getAccountUpgradeStatus") {
    return;
  }
  const getUpgradeStatusParam = Array.isArray(params) ? params[0] : params;
  const account = getUpgradeStatusParam.account;
  const chainId = getUpgradeStatusParam.chainId;
  if (!account || !chainId) {
    throw rpcErrors.invalidParams("wallet_getAccountUpgradeStatus: account and chainId are required");
  }
  const delegationAddress = await getDelegationAddress(account, chainId, getEthCode);
  const isUpgraded = delegationAddress !== null;
  return {
    isUpgraded,
    implementation: delegationAddress !== null && delegationAddress !== void 0 ? delegationAddress : "0x0"
  };
}

export { walletGetUpgradeStatus };
