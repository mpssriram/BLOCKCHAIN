'use strict';

var common = require('@ethereumjs/common');
var tx = require('@ethereumjs/tx');
var util = require('@ethereumjs/util');
var log = require('loglevel');
var constants = require('./constants.js');

/**
 * Transaction decoder for analytics.
 * Decodes eth_sendRawTransaction and eth_sendUserOperation requests.
 */
const transactionDecoder = (req, chainId) => {
  let sender = "";
  let txHash = "";
  try {
    if (req.method === constants.METHOD_TYPES.ETH_SEND_RAW_TRANSACTION) {
      const rawTx = req.params[0];
      const txBytes = util.hexToBytes(util.addHexPrefix(rawTx));
      const tx$1 = tx.createTxFromRLP(txBytes, {
        common: common.createCustomCommon({
          chainId
        }, common.Mainnet)
      });
      sender = tx$1.getSenderAddress().toString();
      txHash = util.bytesToHex(tx$1.hash());
    } else if (req.method === constants.METHOD_TYPES.ETH_SEND_USER_OPERATION) {
      const userOpReq = req;
      sender = userOpReq.params.map(p => p.sender).join(",");
    }
  } catch (error) {
    log.error("Error decoding transaction", error, {
      req,
      chainId
    });
  }
  return [sender, txHash];
};

exports.transactionDecoder = transactionDecoder;
