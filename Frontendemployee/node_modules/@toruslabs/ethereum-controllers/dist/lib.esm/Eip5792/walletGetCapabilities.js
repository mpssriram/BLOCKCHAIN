import { rpcErrors } from '@web3auth/auth';
import { getIsEip7702UpgradeSupported } from '../Eip7702/eip7702Utils.js';
import { EIP_5792_METHODS, Eip5792AtomicStatus } from '../utils/eip5792Types.js';

/**
 * Handler for wallet_getCapabilities (EIP-5792).
 * Returns capabilities per chain, indicating atomicBatch support for upgraded accounts.
 *
 * @param request - The JRPC request with wallet address parameter.
 * @param context - Context containing required functions.
 * @returns Capabilities per chain.
 */
async function walletGetCapabilities(request, getEthCode, context) {
  var _context$getCachedDel;
  const {
    method,
    params
  } = request;
  if (method !== EIP_5792_METHODS.WALLET_GET_CAPABILITIES) {
    return;
  }
  if (!Array.isArray(params)) {
    throw rpcErrors.invalidParams("wallet_getCapabilities: parameters are required");
  }
  const walletAddress = params[0];
  if (!walletAddress) {
    throw rpcErrors.invalidParams("wallet_getCapabilities: wallet address is required");
  }
  const chainsOverride = params[1];
  const supportedChains = chainsOverride || context.getSupportedChains();
  const cachedDelegations = ((_context$getCachedDel = context.getCachedDelegations) === null || _context$getCachedDel === void 0 ? void 0 : _context$getCachedDel.call(context)) || {};
  const capabilities = {};
  for (const chainId of supportedChains) {
    const cacheKey = `${walletAddress.toLowerCase()}-${chainId.toLowerCase()}`;
    let delegationAddress = cachedDelegations[cacheKey];
    let atomicStatus = Eip5792AtomicStatus.SUPPORTED;

    // If not cached, try to fetch
    if (delegationAddress === undefined && getEthCode) {
      try {
        const eip7702UpgradeSupported = await getIsEip7702UpgradeSupported(walletAddress, chainId, getEthCode);
        delegationAddress = eip7702UpgradeSupported.delegationAddress;
        if (delegationAddress === null) {
          atomicStatus = eip7702UpgradeSupported.isSupported ? Eip5792AtomicStatus.READY : Eip5792AtomicStatus.UNSUPPORTED;
        } else {
          var _context$updateDelega;
          // account already upgraded, update the cache
          (_context$updateDelega = context.updateDelegationCache) === null || _context$updateDelega === void 0 || _context$updateDelega.call(context, walletAddress, chainId, delegationAddress);
        }
      } catch {
        atomicStatus = Eip5792AtomicStatus.UNSUPPORTED;
      }
    }
    capabilities[chainId] = {
      atomic: {
        status: atomicStatus
      }
    };
  }
  return capabilities;
}

export { walletGetCapabilities };
